<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceBox - Teleprompter</title>
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/teleprompter.css">
    <style>
        body {
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .teleprompter-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #teleprompter-panel {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #teleprompter-controls nav button {
            background-color: rgba(255, 215, 0, 0.5);
            border-radius: 8px;
            padding: 6px 14px;
            min-height: 36px;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #teleprompter-controls nav button:hover {
            background-color: rgba(255, 215, 0, 0.7);
        }
        #teleprompter-controls nav button svg {
            fill: white;
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>

    <div class="teleprompter-container">
        <!-- Teleprompter Panel -->
        <div id="teleprompter-panel" class="teleprompter-panel show">

            <button class="close-btn" id="teleprompter-close-btn" style="display: none;">&times;</button>
            
            <div id="teleprompter-display">
                <div id="scroll-spacer" style="height: 1rem;"></div>
                <div id="image-wrapper-for-scroll" style="display: none; text-align: center; padding: 10px; background-color: rgba(255, 215, 0, 0.5); border-radius: 8px; margin: 0 5% 1rem 5%;">
                    <img id="bg-image-layer" src="" alt="" style="height: 40vh; width: auto; max-width: 100%; object-fit: contain; border-radius: 4px;">
                </div>
                <div id="teleprompter-text-content"></div>
                <div id="laser-cursor" class="laser-cursor"></div>
            </div>

            <div id="teleprompter-controls">
                <nav>
                    <button id="publish-btn">Publicar</button>
                    <button id="background-btn">Background</button>
                    <button id="teleprompter-play-btn" class="tp-ctrl-btn" title="Play">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 40 40"><path d="M13.333 31.583V8.25l18.334 11.667Zm2.792-11.666Zm0 6.625L26.5 19.917l-10.375-6.625Z"></path></svg>
                    </button>
                    <button id="teleprompter-pause-btn" class="tp-ctrl-btn" title="Pause" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 40 40"><path d="M23.458 31.667V8.333H30v23.334Zm-13.458 0V8.333h6.542v23.334Z"></path></svg>
                    </button>
                    <button id="teleprompter-stop-btn" class="tp-ctrl-btn" title="Stop" style="display:none;">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 40 40"><path d="M10 10h20v20H10z"></path></svg>
                    </button>
                    <div class="drawer" id="teleprompter-drawer">
                        <!-- Background Selector -->
                        <div class="bg-selector-wrapper">
                            <div class="bg-mode-tabs">
                                <button class="bg-tab active" data-bg-mode="color">Color Sólido</button>
                                <button class="bg-tab" data-bg-mode="gradient">Degradado</button>
                                <button class="bg-tab" data-bg-mode="image">Imagen</button>
                            </div>

                            <!-- Panel: Color Sólido -->
                            <div class="bg-panel active" id="bg-panel-color">
                                <input type="color" id="teleprompter-bg-color" value="#000000">
                                <div class="disable-select">Background color</div>
                            </div>

                            <!-- Panel: Degradado -->
                            <div class="bg-panel" id="bg-panel-gradient">
                                <div class="gradient-presets-grid">
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #f97316, #ec4899)" title="Sunset"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #2563eb, #06b6d4)" title="Ocean"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #14532d, #4ade80)" title="Forest"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #7c3aed, #3b82f6)" title="Purple Haze"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #dc2626, #f97316)" title="Fire"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #000000, #1e3a5f)" title="Night"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #b8860b, #fde047)" title="Gold"></button>
                                    <button class="gradient-preset" data-gradient="linear-gradient(135deg, #374151, #9ca3af)" title="Monochrome"></button>
                                </div>
                                <div class="gradient-custom">
                                    <div class="gradient-custom-row">
                                        <label class="disable-select">Color 1</label>
                                        <input type="color" id="gradient-color1" value="#000000">
                                    </div>
                                    <div class="gradient-custom-row">
                                        <label class="disable-select">Color 2</label>
                                        <input type="color" id="gradient-color2" value="#1e3a5f">
                                    </div>
                                    <div class="gradient-custom-row">
                                        <label class="disable-select">Ángulo: <span id="gradient-angle-display">135</span>°</label>
                                        <input type="range" id="gradient-angle" min="0" max="360" value="135" step="1">
                                    </div>
                                    <button class="gradient-apply-btn" id="gradient-apply-custom">Aplicar degradado</button>
                                </div>
                            </div>

                            <!-- Panel: Imagen -->
                            <div class="bg-panel" id="bg-panel-image">
                                <label class="image-upload-btn" for="teleprompter-bg-image">Subir imagen</label>
                                <input type="file" id="teleprompter-bg-image" accept="image/*" style="display:none;">
                                <div class="image-preview-container">
                                    <img id="bg-image-preview" src="" alt="" style="display:none;">
                                    <span class="disable-select" id="bg-image-placeholder">Sin imagen</span>
                                </div>
                                <div class="image-fit-options">
                                    <label class="disable-select">Ajuste:</label>
                                    <select id="bg-image-fit">
                                        <option value="cover" selected>Cover</option>
                                        <option value="contain">Contain</option>
                                        <option value="stretch">Stretch</option>
                                    </select>
                                </div>
                                <div class="image-opacity-row">
                                    <label class="disable-select">Opacidad: <span id="bg-image-opacity-display">50</span>%</label>
                                    <input type="range" id="bg-image-opacity" min="0" max="100" value="50" step="1">
                                </div>
                            </div>
                        </div>
                        <div>
                            <input type="color" id="teleprompter-text-color" value="#ffffff">
                            <div class="disable-select">Text color</div>
                        </div>
                        <div>
                            <input id="teleprompter-text-size" type="range" min="30" max="180" value="58" step="1">
                            <div class="disable-select">Text size: <span id="teleprompter-text-size-display">58</span>px</div>
                        </div>
                        <div>
                            <input id="teleprompter-margin" type="range" min="0" max="40" value="5" step="1">
                            <div class="disable-select">Margin: <span id="teleprompter-margin-display">5</span>%</div>
                        </div>
                        <div>
                            <input id="teleprompter-speed" type="range" min="1" max="50" value="10" step="1">
                            <div class="disable-select">Speed: <span id="teleprompter-speed-display">10</span></div>
                        </div>
                        <div>
                            <label class="audio-nav-btn" for="audio-file-input" style="display:block;width:100%;padding:0.5rem;border:none;border-radius:8px;font-size:0.9rem;font-weight:bold;color:white;cursor:pointer;text-align:center;box-sizing:border-box;">Audio</label>
                            <input type="file" id="audio-file-input" accept="audio/*" style="display:none;">
                            <div id="audio-loaded-info" style="display:none;">
                                <audio id="audio-player" controls style="width:100%;margin-top:0.5rem;"></audio>
                                <button class="audio-remove-btn" id="audio-remove-btn" style="width:100%;margin-top:0.4rem;padding:4px 8px;background:#444;color:#ccc;border:none;border-radius:4px;font-size:0.75rem;cursor:pointer;">Eliminar audio</button>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>

            <div id="teleprompter-script-editor">
                <textarea id="teleprompter-script" placeholder="Pega tu guion aquí..."></textarea>
            </div>
        </div>
    </div>

    <script>
        class Teleprompter {
            constructor(app) {
                this.app = app;
                this.panel = document.getElementById('teleprompter-panel');
                this.display = document.getElementById('teleprompter-display');
                this.laserCursor = document.getElementById('laser-cursor');
                this.bgImageLayer = document.getElementById('bg-image-layer');
                this.textContent = document.getElementById('teleprompter-text-content');
                this.scriptEditor = document.getElementById('teleprompter-script-editor');
                this.script = document.getElementById('teleprompter-script');
                this.controls = document.getElementById('teleprompter-controls');
                this.playBtn = document.getElementById('teleprompter-play-btn');
                this.pauseBtn = document.getElementById('teleprompter-pause-btn');
                this.stopBtn = document.getElementById('teleprompter-stop-btn');
                this.drawer = document.getElementById('teleprompter-drawer');
                this.bgColorPicker = document.getElementById('teleprompter-bg-color');
                this.textColorPicker = document.getElementById('teleprompter-text-color');
                this.textSizeSlider = document.getElementById('teleprompter-text-size');
                this.textSizeDisplay = document.getElementById('teleprompter-text-size-display');
                this.marginSlider = document.getElementById('teleprompter-margin');
                this.marginDisplay = document.getElementById('teleprompter-margin-display');
                this.speedSlider = document.getElementById('teleprompter-speed');
                this.speedDisplay = document.getElementById('teleprompter-speed-display');

                // Background selector elements
                this.bgTabs = document.querySelectorAll('.bg-tab');
                this.bgPanels = document.querySelectorAll('.bg-panel');
                this.gradientPresets = document.querySelectorAll('.gradient-preset');
                this.gradientColor1 = document.getElementById('gradient-color1');
                this.gradientColor2 = document.getElementById('gradient-color2');
                this.gradientAngle = document.getElementById('gradient-angle');
                this.gradientAngleDisplay = document.getElementById('gradient-angle-display');
                this.gradientApplyBtn = document.getElementById('gradient-apply-custom');
                this.bgImageInput = document.getElementById('teleprompter-bg-image');
                this.bgImagePreview = document.getElementById('bg-image-preview');
                this.bgImagePlaceholder = document.getElementById('bg-image-placeholder');
                this.bgImageFit = document.getElementById('bg-image-fit');
                this.bgImageOpacity = document.getElementById('bg-image-opacity');
                this.bgImageOpacityDisplay = document.getElementById('bg-image-opacity-display');

                this.imageWrapperForScroll = document.getElementById('image-wrapper-for-scroll');

                this.audioFileInput = document.getElementById('audio-file-input');
                this.audioPlayer = document.getElementById('audio-player');
                this.audioLoadedInfo = document.getElementById('audio-loaded-info');
                this.audioRemoveBtn = document.getElementById('audio-remove-btn');

                this.isPlaying = false;
                this.isDrawerExpanded = false;
                this.audioReady = false;

                // Background state
                this.bgMode = 'color';
                this.bgImageData = null;
                this.isPreRolling = false;


                this.init();
            }

            init() {
                this.script.addEventListener('input', () => this.updateText());
                this.playBtn.addEventListener('click', () => this.play());
                this.pauseBtn.addEventListener('click', () => this.pause());
                this.stopBtn.addEventListener('click', () => this.stop());

                // Background tabs
                this.bgTabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchBgMode(tab.dataset.bgMode));
                });

                // Solid color
                this.bgColorPicker.addEventListener('input', () => this.applyBackground());

                // Gradient presets
                this.gradientPresets.forEach(preset => {
                    preset.style.background = preset.dataset.gradient;
                    preset.addEventListener('click', () => {
                        this.gradientPresets.forEach(p => p.classList.remove('selected'));
                        preset.classList.add('selected');
                        this.display.style.backgroundImage = preset.dataset.gradient;
                        this.display.style.backgroundColor = 'transparent';
                    });
                });

                // Custom gradient
                this.gradientAngle.addEventListener('input', (e) => {
                    this.gradientAngleDisplay.textContent = e.target.value;
                });
                this.gradientApplyBtn.addEventListener('click', () => this.applyCustomGradient());

                // Image upload
                this.bgImageInput.addEventListener('change', (e) => this.handleImageUpload(e));
                this.bgImageFit.addEventListener('change', () => this.applyBackground());
                
                // Hide opacity controls as they are no longer relevant with the new layout
                this.bgImageOpacity.parentElement.style.display = 'none';

                this.textColorPicker.addEventListener('input', (e) => this.textContent.style.color = e.target.value);
                this.textSizeSlider.addEventListener('input', (e) => this.updateTextSize(e.target.value));
                this.marginSlider.addEventListener('input', (e) => this.updateMargin(e.target.value));
                this.speedSlider.addEventListener('input', (e) => this.updateSpeed(e.target.value));

                document.getElementById('background-btn').addEventListener('click', () => {
                    this.toggleDrawer();
                });


                this.updateText();
                this.updateTextSize(this.textSizeSlider.value);
                this.updateMargin(this.marginSlider.value);
                this.updateSpeed(this.speedSlider.value);

                // Audio
                this.audioFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.audioPlayer.src = URL.createObjectURL(file);
                    this.audioLoadedInfo.style.display = '';
                    this.audioReady = true;

                    // Change speed slider to control playbackRate
                    this.speedSlider.min = 5; // 0.5x
                    this.speedSlider.max = 25; // 2.5x
                    this.speedSlider.value = 10; // 1.0x
                    this.updateSpeed(this.speedSlider.value);
                });
                this.audioRemoveBtn.addEventListener('click', () => {
                    this.audioPlayer.pause();
                    this.audioPlayer.src = '';
                    this.audioLoadedInfo.style.display = 'none';
                    this.audioReady = false;
                    if (this.audioPlayer) {
                        this.audioPlayer.playbackRate = 1.0;
                    }

                    // Reset speed slider to manual mode
                    this.speedSlider.min = 1;
                    this.speedSlider.max = 50;
                    this.speedSlider.value = 10;
                    this.updateSpeed(this.speedSlider.value);
                });
            }

            updateText() {
                this.textContent.innerHTML = this.script.value.replace(/\n/g, '<br>');
            }

            play() {
                this.applyBackground();
                this.isPlaying = true;
                this.playBtn.style.display = 'none';
                this.pauseBtn.style.display = '';
                this.stopBtn.style.display = '';
                this.scriptEditor.style.display = 'none';
                this.controls.style.bottom = '0';
                this.laserCursor.style.display = 'block';
                
                // Push content down so it scrolls fully bottom-to-top
                const displayH = this.display.clientHeight;
                document.getElementById('scroll-spacer').style.height = displayH + 'px';
                this.textContent.style.paddingTop = '0'; // No gap between image and text
                this.textContent.style.paddingBottom = displayH + 'px';
                this.display.style.overflowY = 'hidden';

                this.animFrame = requestAnimationFrame((t) => this.scrollStep(t));

                if (this.audioReady && this.audioPlayer.currentTime < 0.1) {
                    // --- Starting fresh with audio: Start pre-roll ---
                    this.isPreRolling = true;
                    this.lastFrameTime = performance.now(); // Start timer for pre-roll scroll

                    setTimeout(() => {
                        if (this.isPlaying) {
                            // --- Transition from Pre-roll to Audio-Sync ---
                            const maxScroll = this.display.scrollHeight - this.display.clientHeight;
                            if (maxScroll > 0 && this.audioPlayer.duration > 0) {
                                const progress = this.display.scrollTop / maxScroll;
                                const targetTime = progress * this.audioPlayer.duration;
                                
                                // Jump audio to match what's on screen
                                if (targetTime < this.audioPlayer.duration) {
                                    this.audioPlayer.currentTime = targetTime;
                                }
                            }
                            
                            this.audioPlayer.play();
                            this.isPreRolling = false; // Switch to audio-driven scroll
                        }
                    }, 5000); // 5-second delay
                } else if (this.audioReady) {
                    // --- Resuming from pause ---
                    this.audioPlayer.play();
                } else {
                    // --- No audio ---
                    this.lastFrameTime = performance.now();
                }
            }

            scrollStep(timestamp) {
                if (!this.isPlaying) return;

                const maxScroll = this.display.scrollHeight - this.display.clientHeight;

                // Use audio-driven scroll ONLY if audio is ready AND we are past the pre-roll phase.
                if (this.audioReady && this.audioPlayer.duration > 0 && !this.isPreRolling) {
                    // --- AUDIO-DRIVEN SCROLL ---
                    const audioProgress = this.audioPlayer.currentTime / this.audioPlayer.duration;
                    this.display.scrollTop = audioProgress * maxScroll;

                    // Stop when audio ends.
                    if (this.audioPlayer.ended) {
                        this.stop();
                        return;
                    }
                } else {
                    // --- TIME-DRIVEN SCROLL (Used for No-Audio mode AND Pre-roll) ---
                    const delta = timestamp - this.lastFrameTime;
                    this.lastFrameTime = timestamp;
                    const pxPerSec = parseInt(this.speedSlider.value) * 3;
                    this.display.scrollTop += pxPerSec * (delta / 1000);

                    // Stop when all text has scrolled off screen
                    if (this.display.scrollTop >= maxScroll) {
                        this.stop();
                        return;
                    }
                }

                // Continue the animation loop
                this.animFrame = requestAnimationFrame((t) => this.scrollStep(t));
            }

            pause() {
                this.isPlaying = false;
                this.playBtn.style.display = '';
                this.pauseBtn.style.display = 'none';
                this.stopBtn.style.display = '';
                cancelAnimationFrame(this.animFrame);
                if (this.audioReady) this.audioPlayer.pause();
            }

            stop() {
                this.isPlaying = false;
                this.isPreRolling = false;
                cancelAnimationFrame(this.animFrame);
                this.display.scrollTop = 0;
                document.getElementById('scroll-spacer').style.height = '1rem';
                this.textContent.style.paddingTop = '0';
                this.textContent.style.paddingBottom = '0';
                this.laserCursor.style.display = 'none';
                this.display.style.overflowY = 'hidden';
                this.scriptEditor.style.display = '';
                this.controls.style.bottom = '200px';
                this.playBtn.style.display = '';
                this.pauseBtn.style.display = 'none';
                this.stopBtn.style.display = 'none';
                if (this.audioReady) {
                    this.audioPlayer.pause();
                    this.audioPlayer.currentTime = 0;
                }
            }

            toggleDrawer() {
                this.isDrawerExpanded = !this.isDrawerExpanded;
                this.drawer.classList.toggle('expanded');
            }

            updateTextSize(size) {
                this.textContent.style.fontSize = `${size}px`;
                this.textSizeDisplay.textContent = size;
            }

            updateMargin(margin) {
                this.display.style.padding = `0 ${margin}%`;
                this.marginDisplay.textContent = margin;
            }

            updateSpeed(speed) {
                if (this.audioReady) {
                    const playbackRate = parseFloat(speed) / 10;
                    this.speedDisplay.textContent = `${playbackRate.toFixed(1)}x`;
                    if (this.audioPlayer) {
                        this.audioPlayer.playbackRate = playbackRate;
                    }
                } else {
                    this.speedDisplay.textContent = parseInt(speed);
                }
            }

            switchBgMode(mode) {
                this.bgMode = mode;
                this.bgTabs.forEach(t => t.classList.toggle('active', t.dataset.bgMode === mode));
                this.bgPanels.forEach(p => p.classList.remove('active'));
                document.getElementById(`bg-panel-${mode}`).classList.add('active');
                this.applyBackground();
            }

            applyBackground() {
                if (this.bgMode === 'image') {
                    // When image is active, teleprompter background is black.
                    this.display.style.backgroundImage = 'none';
                    this.display.style.backgroundColor = '#000';
                    this.applyImageBackground();
                } else {
                    // For color or gradient, apply to the display and hide the image wrapper.
                    this.imageWrapperForScroll.style.display = 'none';
                    if (this.bgMode === 'color') {
                        this.display.style.backgroundImage = 'none';
                        this.display.style.backgroundColor = this.bgColorPicker.value;
                    } else if (this.bgMode === 'gradient') {
                        if (!this.display.style.backgroundImage || this.display.style.backgroundImage === 'none') {
                            this.applyCustomGradient();
                        }
                    }
                }
            }

            applyCustomGradient() {
                this.gradientPresets.forEach(p => p.classList.remove('selected'));
                const angle = this.gradientAngle.value;
                const c1 = this.gradientColor1.value;
                const c2 = this.gradientColor2.value;
                this.display.style.backgroundImage = `linear-gradient(${angle}deg, ${c1}, ${c2})`;
                this.display.style.backgroundColor = 'transparent';
            }

            handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.bgImageData = ev.target.result;
                    this.bgImagePreview.src = this.bgImageData;
                    this.bgImagePreview.style.display = 'block';
                    this.bgImagePlaceholder.style.display = 'none';
                    this.applyBackground();
                };
                reader.readAsDataURL(file);
            }

            applyImageBackground() {
                if (!this.bgImageData) {
                    this.imageWrapperForScroll.style.display = 'none';
                    return;
                }
                this.imageWrapperForScroll.style.display = 'block';
                this.bgImageLayer.src = this.bgImageData;

                const fit = this.bgImageFit.value;
                if (fit === 'stretch') {
                    this.bgImageLayer.style.objectFit = 'fill';
                } else {
                    this.bgImageLayer.style.objectFit = fit;
                }
            }

        }

        // Since we removed the main app, we instantiate Teleprompter directly.
        document.addEventListener('DOMContentLoaded', () => {
            new Teleprompter(null);
        });
    </script>

</body>
</html>